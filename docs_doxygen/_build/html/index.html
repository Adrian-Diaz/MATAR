<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MATAR: MATAR</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MATAR
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">MATAR </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p  align="center"><a class="anchor" id="md__Users_calvinroth_paraNotes_MATAR_README"></a></p>
<p ><img src="https://github.com/lanl/MATAR/blob/main/MATAR_Logo.png" alt="" width="350" class="inline"/></p>
<p >MATAR is a C++ library that addresses the need for simple, fast, and memory-efficient multi-dimensional data representations for dense and sparse storage that arise with numerical methods and in software applications. The data representations are designed to perform well across multiple computer architectures, including CPUs and GPUs. MATAR allows users to easily create and use intricate data representations that are also portable across disparate architectures using Kokkos. The performance aspect is achieved by forcing contiguous memory layout (or as close to contiguous as possible) for multi-dimensional and multi-size dense or sparse MATrix and ARray (hence, MATAR) types. Results show that MATAR has the capability to improve memory utilization, performance, and programmer productivity in scientific computing. This is achieved by fitting more work into the available memory, minimizing memory loads required, and by loading memory in the most efficient order.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Examples</h1>
<ul>
<li><a href="https://github.com/lanl/ELEMENTS/">ELEMENTS</a>: MATAR is a part of the ELEMENTS Library (LANL C# C20058) and it underpins the routines implemented in ELEMENTS. MATAR is available in a stand-alone directory outside of the ELEMENTS directory because it can aid many code applications. The dense and sparse storage types in MATAR are the foundation for the ELEMENTS library, which contains mathematical functions to support a very broad range of element types including: linear, quadratic, and cubic serendipity elements in 2D and 3D; high-order spectral elements; and a linear 4D element. An unstructured high-order mesh class is available in ELEMENTS and it takes advantage of MATAR for efficient access of various mesh entities.</li>
<li><a href="https://github.com/lanl/Fierro">Fierro</a>: The MATAR library underpins the Fierro code that is designed to simulate quasi-static solid mechanics problems and material dynamics problems. <br  />
</li>
<li>Simple examples are in the /test folder</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
Descriptions</h1>
<ul>
<li>All Array MATAR types (e.g., <a class="el" href="d1/dbe/class_c_array.html">CArray</a>, <a class="el" href="dc/dbd/class_view_c_array.html">ViewCArray</a>, <a class="el" href="de/d57/class_f_array.html">FArray</a>, <a class="el" href="d1/da3/class_ragged_right_array.html">RaggedRightArray</a>, etc.) start with an index of 0 and stop at an index of N-1, where N is the number of entries. <br  />
</li>
<li>All Matrix MATAR types (e.g., <a class="el" href="d2/dcb/class_c_matrix.html">CMatrix</a>, <a class="el" href="d8/dad/class_view_c_matrix.html">ViewCMatrix</a>, <a class="el" href="dc/d2f/class_f_matrix.html">FMatrix</a>, etc.) start with an index of 1 and stop at an index of N, where N is the number of entries.</li>
<li>The MATAR View types (e.g., <a class="el" href="dc/dbd/class_view_c_array.html">ViewCArray</a>, <a class="el" href="d8/dad/class_view_c_matrix.html">ViewCMatrix</a>, <a class="el" href="de/d36/class_view_f_array.html">ViewFArray</a>, etc. ) are designed to accept a pointer to an existing 1D array and then access that 1D data as a multi-dimensional array. The MATAR View types can also be used to slice an existing View. <br  />
</li>
<li>The C dense storage and View types (e.g., <a class="el" href="d1/dbe/class_c_array.html">CArray</a>, <a class="el" href="dc/dbd/class_view_c_array.html">ViewCArray</a>, <a class="el" href="d2/dcb/class_c_matrix.html">CMatrix</a>, etc.) access the data following the C/C++ language convection of having the last index in a multi-dimensional array vary the quickest. In a 2D <a class="el" href="d1/dbe/class_c_array.html">CArray</a> A, the index j in A(i,j) varies first followed by the index i, so the optimal performance is achieved using the following loop ordering. <div class="fragment"><div class="line">// Optimal use of CArray</div>
<div class="line">for (i=0,i&lt;N,i++){</div>
<div class="line">    for (j=0,j&lt;N,j++){</div>
<div class="line">        A(i,j) = 0.0;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>The F dense storage and View types (e.g., <a class="el" href="de/d57/class_f_array.html">FArray</a>, <a class="el" href="de/d36/class_view_f_array.html">ViewFArray</a>, <a class="el" href="dc/d2f/class_f_matrix.html">FMatrix</a>, etc.) access the data following the Fortran language convection of having the first index in a multi-dimensional array vary the quickest. In a 2D <a class="el" href="dc/d2f/class_f_matrix.html">FMatrix</a> M, the index i in M(i,j) varies first followed by the index j, so the optimal performance is achieved using the following loop ordering.</li>
</ul>
<div class="fragment"><div class="line">// Optimal use of FMatrix</div>
<div class="line">for (j=1,j&lt;=N,j++){</div>
<div class="line">    for (i=1,i&lt;=N,i++){</div>
<div class="line">        M(i,j) = 0.0;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li>The ragged data types (e.g., <a class="el" href="d1/da3/class_ragged_right_array.html">RaggedRightArray</a>, <a class="el" href="d1/d2d/class_ragged_down_array.html">RaggedDownArray</a>, etc) in MATAR are special sparse storage types. The Right access types are for R(i,j) where the number of column entries varies in width across the array. The Down access types are for D(i,j) where the number of row entries vary in length across the array.</li>
<li>The <a class="el" href="d6/d52/class_sparse_row_array.html">SparseRowArray</a> MATAR type is the idetical to the Compressed Sparse Row (CSR) or Compressed Row Storage (CSR) respresentation.</li>
<li>The SparseColumnArray MATAR type is identical to the Compressed Sparse Column (CSC) or Compressed Column Storage (CCS) respresentation.</li>
</ul>
<h1><a class="anchor" id="autotoc_md3"></a>
Usage</h1>
<div class="fragment"><div class="line">// create a 1D array of integers and then access as a 2D array</div>
<div class="line">int A[9];</div>
<div class="line">auto A_array = ViewCArray &lt;int&gt; (A, 3, 3); // access as A(i,j) </div>
<div class="line"> </div>
<div class="line">// create a 3D array of doubles</div>
<div class="line">auto B = CArray &lt;double&gt; (3,3,3); // access as B(i,j,k)</div>
<div class="line"> </div>
<div class="line">// create a slice of the 3D array at index 1</div>
<div class="line">auto C = ViewCArray &lt;double&gt; (&amp;B(1,0,0),3,3); // access as C(j,k)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">// create a 4D matrix of doubles, indices start at 1 </div>
<div class="line">auto D = CMatrix &lt;double&gt; (10,9,8,7); // access as D(i,j,k,l)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">// create a 2D view of a standard array</div>
<div class="line">std::array&lt;int, 9&gt; E1d;</div>
<div class="line">auto E = ViewCArray&lt;int&gt; (&amp;E1d[0], 3, 3);</div>
<div class="line">E(0,0) = 1;  // and so on</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">// create a ragged-right array of integers</div>
<div class="line">//</div>
<div class="line">// [1, 2, 3]</div>
<div class="line">// [4, 5]</div>
<div class="line">// [6]</div>
<div class="line">// [7, 8, 9, 10]</div>
<div class="line">//</div>
<div class="line">size_t my_strides[4] = {3, 2, 1, 4};</div>
<div class="line">RaggedRightArray &lt;int&gt; ragged(my_strides, 4);</div>
<div class="line">    </div>
<div class="line">int value = 1;</div>
<div class="line">for (int i=0; i&lt;4; i++){</div>
<div class="line">    for (int j=0; j&lt;my_ragged.stride(i); j++){</div>
<div class="line">        ragged(i,j) = value;</div>
<div class="line">        value++;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4"></a>
Cloning the code</h1>
<p >If your SSH keys are set in github, then from the terminal type: </p><div class="fragment"><div class="line">git clone --recursive ssh://git@github.com/lanl/MATAR.git    </div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md5"></a>
Basic build</h1>
<p >The basic build is for users only interested in the serial CPU only MATAR data types. For this build, we recommend making a folder perhaps called build then go into the build folder and type </p><div class="fragment"><div class="line">cmake ..</div>
<div class="line">make</div>
</div><!-- fragment --><p> The compiled code will be in the build folder.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Debug basic build</h1>
<p >To build serial CPU only MATAR data types in the debug mode, please use </p><div class="fragment"><div class="line">cmake -DCMAKE_BUILD_TYPE=Debug ..</div>
<div class="line">make</div>
</div><!-- fragment --><p> The debug flag includes checks on array and matrix dimensions and index bounds.</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Building MATAR with Kokkos</h1>
<p >A suite of build scripts are provided to build MATAR with Kokkos for performance portability across computer architectures (CPUs and GPUs). The scripts for various Kokkos backends (e.g., CUDA, HIP, OpenMP, and pthreads) are located within the scripts folder. The provided scripts are configured for particular hardware, the user will likely need to alter the inputs to reflect their hardware. There are three scripts in each folder that are sourced to build MATAR with Kokkos. The scripts are </p><div class="fragment"><div class="line">sourceme-env.sh</div>
<div class="line">kokkos-install.sh</div>
<div class="line">backend-cmake-build.sh</div>
</div><!-- fragment --><p> The word backend denotes cuda, hip, openMP, and so forth. Scripts are also provided to build MATAR without Kokkos, and in that case there is no backend listed since it doesn't use Kokko. The backend-cmake-build.sh script will run cmake and make for the project. Afterwords, the user can just runs make inside the respective build directory to compile the project. For clarity, running all the scripts is only necessary to set up and compile the code the first time, afterwards, the use can compile the code using make in the build directory. The environment variables will need to be set when logging into a compute node or when changing to a different kokkos backend. For all builds, a single script is provided in each script folder to automate the entire build process, it runs the three aforementioned scripts sequentially. </p><div class="fragment"><div class="line">build-it.sh</div>
</div><!-- fragment --><p> Before using the build-it.sh script, the user must verify that the settings in the other scripts that build MATAR with a Kokkos backend are correctly set. After running the build-it.sh script, the entire project is compiled and stored in a directory that is named with the respective Kokkos backend e.g., build-kokkos-cuda. Further details are provided on the three scripts to configure and build MATAR with a Kokkos backend.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Environment configuration script</h2>
<p >To start, the environment variables and modules must be configured by sourcing the following script </p><div class="fragment"><div class="line">source sourceme-env.sh</div>
</div><!-- fragment --><p> This script is where the user will load the necessary module files for their given machine/architecture combination. This script also creates the build directory for the project e.g., build-kokkos-cuda, build-kokkos-hip, build-kokkos-openmp, etc.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Install Kokkos script</h2>
<p >The next step is to install Kokkos, using the version that was cloned recursively within MATAR, and configure the Kokkos build for specific hardware and a backend. <br  />
 </p><div class="fragment"><div class="line">source kokkos-install.sh</div>
</div><!-- fragment --><p> Within this script, the user will need to set any Kokkos specific variables for their project. The architecture variables will need to be modified based on the architecture being used. The provided scripts are set for a particular hardware that might differ from what a user might be using. CPU architecture information needs to be listed if running with the Kokkos serial or OpenMP backends; GPU architecture information must be listed if using a Kokkos GPU backend. We refer the user to Kokkos compiling page to see the large list of compilation options, </p><div class="fragment"><div class="line">https://github.com/kokkos/kokkos/wiki/Compiling</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md10"></a>
CUDA compilation script</h2>
<p >To build the project with cuda, the last step is to type </p><div class="fragment"><div class="line">source cuda-cmake-build.sh</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md11"></a>
HIP compilation script</h2>
<p >To build the project with hip, the last step is to type </p><div class="fragment"><div class="line">source hip-cmake-build.sh</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md12"></a>
openMP compilation script</h2>
<p >To build the project with openMP, the last step is to type</p>
<div class="fragment"><div class="line">source openmp-cmake-build.sh</div>
</div><!-- fragment --><p> The sourceme-env.sh script (the first step) sets the number of threads to 16 by default. Changing the number of threads used with openMP requires manually setting the environment variable OMP_NUM_THREADS. <br  />
</p>
<h2><a class="anchor" id="autotoc_md13"></a>
pthreads compilation script</h2>
<p >To build the project with ptheads, the last step is to type </p><div class="fragment"><div class="line">source pthreads-cmake-build.sh</div>
</div><!-- fragment --><p> To specify number of threads when running a code with the Kokkos pthread backend, add the following command line arguments </p><div class="fragment"><div class="line">--kokkos-threads=4</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md14"></a>
Automate build process</h2>
<p >A build-it.sh script is provided that runs all scripts sequentially for the user. The build-it.sh script obviates the need to manually source each script. The user must verify the settings are correct in each script prior to using the build-it.sh script. If the build-it.sh script fails to build the project correctly, the user should carefully look at the loaded modules and settings for building Kokkos. <br  />
</p>
<h1><a class="anchor" id="autotoc_md15"></a>
Contributing</h1>
<p >Pull requests are welcome. For major changes, please open an issue first to discuss what you would like to change.</p>
<h1><a class="anchor" id="autotoc_md16"></a>
License</h1>
<p >This program is open source under the BSD-3 License.</p>
<h1><a class="anchor" id="autotoc_md17"></a>
Citation</h1>
<div class="fragment"><div class="line">@article{MATAR,</div>
<div class="line">title = &quot;{MATAR: A Performance Portability and Productivity Implementation of Data-Oriented Design with Kokkos}&quot;,</div>
<div class="line">journal = {Journal of Parallel and Distributed Computing},</div>
<div class="line">pages = {86-104},</div>
<div class="line">volume = {157},</div>
<div class="line">year = {2021},</div>
<div class="line">author = {Daniel J. Dunning and Nathaniel R. Morgan and Jacob L. Moore and Eappen Nelluvelil and Tanya V. Tafolla and Robert W. Robey},</div>
<div class="line">keywords = {Performance, Portability, Productivity, Memory Efficiency, GPUs, dense and sparse storage}</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4
</small></address>
</body>
</html>
